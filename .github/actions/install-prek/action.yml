# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
name: 'Install prek'
description: 'Installs prek and related packages'
inputs:
  python-version:
    description: 'Python version to use'
    default: "3.10"
  uv-version:
    description: 'uv version to use'
    default: "0.9.11"  # Keep this comment to allow automatic replacement of uv version
  prek-version:
    description: 'prek version to use'
    default: "0.3.2"  # Keep this comment to allow automatic replacement of prek version
runs:
  using: "composite"
  steps:
    - name: Install prek, uv
      shell: bash
      env:
        UV_VERSION: ${{inputs.uv-version}}
        PREK_VERSION: ${{inputs.prek-version}}
      run: |
        pip install uv==${UV_VERSION} || true
        uv tool install prek==${PREK_VERSION} --with uv==${UV_VERSION}
      working-directory: ${{ github.workspace }}
    # We need to use tar file with archive to restore all the permissions and symlinks
    - name: "Delete ~.cache"
      run: |
        du ~/ --max-depth=2
        echo
        echo Deleting ~/.cache
        echo
        rm -rf ~/.cache
        echo
      shell: bash
    - name: "Restore prek cache"
      uses: apache/infrastructure-actions/stash/restore@c94b890bbedc2fc61466d28e6bd9966bc6c6643c
      with:
        key: cache-prek-v4-${{ inputs.python-version }}-${{ hashFiles('.pre-commit-config.yaml') }}
        path: /tmp/
      id: restore-preK-cache
    - name: "Restore .cache from the tar file"
      run: tar -C ~ -xzf /tmp/cache-prek.tar.gz
      shell: bash
      if: steps.restore-prek-cache.outputs.stash-hit == 'true'
    - name: "Show restored files"
      run: |
        echo "Restored files"
        du ~/ --max-depth=2
        echo
      shell: bash
      if: steps.restore-prek-cache.outputs.stash-hit == 'true'
    - name: Install prek hooks
      shell: bash
      run: prek install-hooks || (cat ~/.cache/prek/prek.log && exit 1)
      working-directory: ${{ github.workspace }}
